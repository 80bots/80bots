version: '3'
services:

  # Nginx proxy server
  # Image: https://hub.docker.com/_/nginx
  proxy:
    image: nginx
    container_name: 80bots-proxy
    restart: unless-stopped
    ports:
      - "${DOCKER_WEB_SERVER_PORT:-80}:${DOCKER_WEB_SERVER_PORT:-80}"
      - "${DOCKER_API_SERVER_PORT:-8080}:${DOCKER_API_SERVER_PORT:-8080}"
      - "${DOCKER_SOCKET_SERVER_PORT:-6001}:${DOCKER_SOCKET_SERVER_PORT:-6001}"
    env_file:
      - .env
    environment:
      WEB_SERVER_HOST: "${DOCKER_WEB_SERVER_HOST:-localhost}"
      WEB_SERVER_PORT: "${DOCKER_WEB_SERVER_PORT:-80}"
      API_SERVER_HOST: "${DOCKER_API_SERVER_HOST:-localhost}"
      API_SERVER_PORT: "${DOCKER_API_SERVER_PORT:-8080}"
      SOCKET_SERVER_HOST: "${DOCKER_SOCKET_SERVER_HOST:-localhost}"
      SOCKET_SERVER_PORT: "${DOCKER_SOCKET_SERVER_PORT:-6001}"
    command: /bin/bash -c "envsubst < /etc/nginx/src/http-server.template.conf > /etc/nginx/conf.d/http-server.conf && exec nginx -g 'daemon off;'"
    volumes:
      - ./docker-compose/proxy/src:/etc/nginx/src
      - ./docker-compose/proxy/conf.d:/etc/nginx/conf.d
    links:
      - web
      - api
      - ws
    depends_on:
      - api
      - web
      - ws
    networks:
      - app-network

  # React Web Client
  # Image: ./docker-compose/web/Dockerfile
  web:
    container_name: 80bots-web
    build:
      context: ./docker-compose/web
    command: /var/www/start.sh
    restart: unless-stopped
    env_file:
      - .env
    environment:
      GIT_USER: "${GIT_USER}"
      GIT_EMAIL: "${GIT_EMAIL}"
      API_URL: "${API_URL:-http://localhost:8080/api}"
      SOCKET_URL: "${SOCKET_URL:-http://localhost:6001}"
      SOCKET_AUTH_URL: "${SOCKET_AUTH_URL:-http://localhost:8080/broadcasting/auth}"
    volumes:
      - ./docker-compose/web/app:/var/www/app
    networks:
      - app-network
    depends_on:
      - api
      - ws

  # API
  # Image: ./docker-compose/api/Dockerfile
  api:
    container_name: 80bots-api
    build:
      context: ./docker-compose/backend
    command: /var/www/start.sh
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./docker-compose/backend/app:/var/www/app
      - ./docker-compose/backend/supervisor:/etc/supervisor
    links:
      - mysql
      - redis
    networks:
      - app-network
    depends_on:
      - mysql
      - redis
      - ws

  # Web Sockets based on Laravel Echo Server
  # Image: https://hub.docker.com/r/oanhnn/laravel-echo-server
  ws:
    image: oanhnn/laravel-echo-server
    container_name: 80bots-ws
    restart: unless-stopped
    env_file:
      - .env
    environment:
      LARAVEL_ECHO_SERVER_AUTH_HOST: "${API_URL:-api}"
      LARAVEL_ECHO_SERVER_HOST: "0.0.0.0"
      LARAVEL_ECHO_SERVER_PORT: "8000"
      LARAVEL_ECHO_SERVER_DEBUG: "${APP_DEBUG:-false}"
      LARAVEL_ECHO_SERVER_REDIS_HOST: "${REDIS_HOST:-redis}"
      LARAVEL_ECHO_SERVER_REDIS_PORT: "${REDIS_PORT:-6379}"
      LARAVEL_ECHO_SERVER_REDIS_PASSWORD: "${REDIS_PASSWORD:-root}"
      REDIS_PREFIX: "${REDIS_PREFIX:-master}"
      LARAVEL_ECHO_SERVER_PROTO: "http"
    volumes:
      - ./docker-compose/ws/conf.d:/app
    links:
      - redis
    depends_on:
      - redis
    networks:
      - app-network

  # Primary DB - MySQL
  # Image: https://hub.docker.com/_/mysql
  mysql:
    image: mysql:5.7
    container_name: 80bots-mysql
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_USER: root
      MYSQL_ROOT_PASSWORD: "${DOCKER_MYSQL_ROOT_PASSWORD:-root}"
      MYSQL_USER: "${DOCKER_MYSQL_USER:-user}"
      MYSQL_PASSWORD: "${DOCKER_MYSQL_PASSWORD:-user}"
      MYSQL_DATABASE: "${DOCKER_MYSQL_DATABASE:-80bots}"
    volumes:
      - ./docker-compose/mysql/conf.d:/etc/mysql/conf.d/
      - ./docker-compose/mysql/data:/var/lib/mysql
    networks:
      - app-network

  # Redis
  # Image: https://hub.docker.com/_/redis/
  redis:
    build:
      context: ./docker-compose/redis
    container_name: 80bots-redis
    restart: unless-stopped
    volumes:
      - ./docker-compose/redis/data:/data
    networks:
      - app-network
networks:
  app-network:
    driver: bridge